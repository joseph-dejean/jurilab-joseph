{
  "rules": {
    "lawyers": {
      ".read": true,
      // Admins can write to any lawyer profile
      ".write": "root.child('users').child(auth.uid).child('role').val() === 'ADMIN'",
      "$uid": {
        // A user can write to their own lawyer profile if authenticated
        ".write": "auth != null && auth.uid === $uid"
      }
    },
    "users": {
      // Admins can read and write all user data
      ".read": "root.child('users').child(auth.uid).child('role').val() === 'ADMIN'",
      ".write": "root.child('users').child(auth.uid).child('role').val() === 'ADMIN'",
      "$uid": {
        // A user can read or write to their own user profile
        ".read": "auth != null && auth.uid === $uid",
        ".write": "auth != null && auth.uid === $uid"
      }
    },
    "appointments": {
      // Allow authenticated users to read all appointments (filtering is done client-side)
      // This is acceptable for small-to-medium scale apps
      ".read": "auth != null",
      // Only allow creating appointments (clients can create, admins can update)
      ".write": false,
      ".indexOn": ["clientId", "lawyerId"], // Improves query performance
      "$appointmentId": {
        // A user can read an appointment if they are the client or the lawyer
        ".read": "auth != null && (data.child('clientId').val() === auth.uid || data.child('lawyerId').val() === auth.uid)",
        // A user can create an appointment if they are authenticated and are the client for that appointment
        // Allow client to create, and anyone to update (admins)
        ".write": "!data.exists() && auth != null && newData.child('clientId').val() === auth.uid || data.exists()",
        ".validate": "newData.hasChildren(['id', 'lawyerId', 'clientId', 'date', 'status', 'type'])"
      }
    },
    "chatPermissions": {
      "$channelId": {
        ".read": "auth != null && (data.child('lawyerId').val() === auth.uid || data.child('clientId').val() === auth.uid || !data.exists())",
        ".write": "auth != null && (newData.child('lawyerId').val() === auth.uid || (data.exists() && data.child('lawyerId').val() === auth.uid))",
        "clientCanMessage": {
          ".read": "auth != null && (root.child('chatPermissions').child($channelId).child('lawyerId').val() === auth.uid || root.child('chatPermissions').child($channelId).child('clientId').val() === auth.uid || !root.child('chatPermissions').child($channelId).exists())",
          ".write": "auth != null && root.child('chatPermissions').child($channelId).child('lawyerId').val() === auth.uid"
        }
      }
    }
  }
}
